name: CI - Build & Push Docker image + Update Helm values

on:
  push:
    branches: ["main"]
    paths:
      - "src/**"
      - "package.json"
      - "Dockerfile"
      - "helm/**"
      - ".github/workflows/ci-build-push.yml"

# MUHIM: workflow repo'ga push qilishi uchun
permissions:
  contents: write

concurrency:
  group: ci-build-push-update-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_push_update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Generate image tag (short sha)
        id: vars
        shell: bash
        run: echo "TAG=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            aqll/agri-food-api:${{ steps.vars.outputs.TAG }}
            aqll/agri-food-api:latest

      - name: Update Helm values.yaml image tag
        shell: bash
        env:
          TAG: ${{ steps.vars.outputs.TAG }}
        run: |
          FILE="helm/agri-food-api/values.yaml"
          if [ ! -f "$FILE" ]; then
            echo "ERROR: $FILE not found" && exit 1
          fi

          # faqat image: blok ichidagi tag: ni almashtiramiz
          awk -v tag="$TAG" '
            BEGIN{in_image=0}
            /^image:/{in_image=1; print; next}
            in_image==1 && /^[^[:space:]]/{in_image=0}
            in_image==1 && $1 ~ /^tag:/{sub($0,"  tag: "tag); print; next}
            {print}
          ' "$FILE" > "$FILE.tmp" && mv "$FILE.tmp" "$FILE"

          echo "Updated tag to $TAG in $FILE"
          grep -n "image:\|tag:" -n "$FILE" | head -n 20 || true

      - name: Commit changes
        shell: bash
        env:
          TAG: ${{ steps.vars.outputs.TAG }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add helm/agri-food-api/values.yaml

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "ci: update image tag to ${TAG} [skip ci]"

      - name: Push changes
        shell: bash
        run: |
          git push origin HEAD:main
